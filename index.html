<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æŒ¿çµµãƒ»æå†™ç²¾åº¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root{
      --bg:#0b0c10; --panel:#151821; --ink:#e8ecf1; --muted:#a7b0bd; --accent:#5aa9e6; --ok:#3ccf91;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
    .wrap{max-width:1050px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.3)}
    .pad{padding:20px}
    h1{font-size:clamp(20px,2.4vw,28px);margin:0 0 12px}
    p{color:var(--muted);line-height:1.7}
    label{display:block;margin:10px 0;color:var(--ink)}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);background:#0f1117;color:var(--ink)}
    button{appearance:none;border:0;background:var(--accent);color:#071018;
      padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .space{height:12px}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .sceneBox{background:#0f1117;border:1px dashed rgba(255,255,255,.1);
      border-radius:12px;padding:14px}
    .sceneTitle{font-weight:800;letter-spacing:.04em;margin-bottom:6px}
    .imgWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      background:#0b0d13;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      padding:8px;
      width:100%;
      max-width:300px;   /* PCã§ã¯æœ€å¤§700pxã¾ã§åºƒã’ã‚‹ */
      margin:20px auto;     /* ä¸­å¤®å¯„ã› */
    }
    
    img{
      width:100%;
      height:auto;       /* é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ */
      max-height:35vh;   /* ã‚¹ãƒãƒ›ç”»é¢ã§ç¸¦ãŒå¤§ãã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
      object-fit:contain;
      border-radius:10px;
      display:block;
    }

    @media (min-width: 900px) {
      .imgWrap {
        max-width: 450px; /* ğŸ’¡ PCã ã‘å¤§ããï¼ˆä¾‹ï¼š500pxï¼‰ */
      }
    }
    .controls{display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-top:12px}
    .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .progress{height:10px;background:#0f1117;border-radius:999px;overflow:hidden;
      border:1px solid rgba(255,255,255,.08)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--ok),#5aa9e6)}
    .tag{display:inline-block;background:#0f1117;border:1px solid rgba(255,255,255,.08);
      padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .tiny{font-size:12px}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--ink)}
    .hidden{display:none}
    .foot{display:flex;gap:8px;align-items:center;justify-content:flex-end}

    /* --- ãƒãƒƒã‚¸è£…é£¾ --- */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      color: white;
    }
    .b-ok { background: #3ccf91; }      /* ç·‘ï¼šæå†™ã§ãã¦ã„ã‚‹ */
    .b-mid { background: #ffcc66; color:#000; } /* é»„ï¼šã©ã¡ã‚‰ã§ã‚‚ãªã„ */
    .b-ng { background: #ff6b6b; }      /* èµ¤ï¼šæå†™ã§ãã¦ã„ãªã„ */
    /* --- ãƒãƒƒã‚¸æ–‡å­—ã‚’é»’ã«å¤‰æ›´ --- */
    .b-ok, .b-ng {
      color: #000 !important;  /* å¼·åˆ¶çš„ã«é»’æ–‡å­—ã«ã™ã‚‹ */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="app" class="card pad">
      <section id="stepIntro">
        <h1>æŒ¿çµµãƒ»æå†™ç²¾åº¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>
        <p>
          æœ¬ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§ã¯ã€å°èª¬ã€æµ¦å³¶å¤ªéƒã€ã®ä¸€éƒ¨ã‚’ã‚‚ã¨ã«ã€ç”»åƒç”ŸæˆAIã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸæŒ¿çµµã‚’è©•ä¾¡ã—ã¦ã„ãŸã ãã¾ã™ã€‚<br><br>
          å„ã‚·ãƒ¼ãƒ³ã”ã¨ã«ã€å…ƒã®æ–‡ç« ã¨ç”Ÿæˆã•ã‚ŒãŸç”»åƒï¼ˆ1ã‚·ãƒ¼ãƒ³ã‚ãŸã‚Šè¨ˆ30æšï¼‰ã‚’è¦‹æ¯”ã¹ã¦ãã ã•ã„ã€‚<br><br>
          ãã®ã†ãˆã§ã€å„ç”»åƒã‚’
          <strong>ã€Œæ–‡ç« ã®å†…å®¹ã‚’æå†™ã§ãã¦ã„ã‚‹ã€</strong>ãƒ»
          <strong>ã€Œæ–‡ç« ã®å†…å®¹ã‚’æå†™ã§ãã¦ã„ãªã„ã€</strong>ãƒ»
          <strong>ã€Œã©ã¡ã‚‰ã§ã‚‚ãªã„ã€</strong>
          ã®ã„ãšã‚Œã‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </p>

        <p>
          ä»¥ä¸‹ã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è¨˜å…¥æ–¹æ³•ã§ã™ã€‚<br><br>
          ã€Œæ¬¡ã¸ï¼ˆé–‹å§‹ï¼‰ã€ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€ã‚·ãƒ¼ãƒ³æœ¬æ–‡ã¨ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
          æœ¬æ–‡ã¨ç”»åƒã‚’è¦‹æ¯”ã¹ã€
          <span class="badge b-ok">ã€Œæå†™ã§ãã¦ã„ã‚‹ã€</span><span class="badge b-mid">ã€Œã©ã¡ã‚‰ã§ã‚‚ãªã„ã€</span><span class="badge b-ng">ã€Œæå†™ã§ãã¦ã„ãªã„ã€</span>
          ã®ã„ãšã‚Œã‹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€ã€Œæ¬¡ã¸ã€ã‚’æŠ¼ä¸‹ã—ã¦ãã ã•ã„ã€‚<br>
          â€»ã€Œæ¬¡ã¸ã€ã‚’æŠ¼ä¸‹ã—ãŸéš›ã€æ•°ç§’ã®ãƒ©ã‚°ãŒç™ºç”Ÿã—ã¾ã™ãŒã€
          ã€Œæ¬¡ã¸ã€ã‚’2å›ä»¥ä¸ŠæŠ¼ä¸‹ã—ãªã„ã§ãã ã•ã„ã€‚<br><br>
          30æšã®ç”»åƒã®è©•ä¾¡ã‚’çµ‚ãˆã‚‹ã¨æ¬¡ã®ã‚·ãƒ¼ãƒ³ã«é€²ã¿ã¾ã™ï¼ˆå…¨5ã‚·ãƒ¼ãƒ³ï¼‰ã€‚<br>
          è©•ä¾¡çµ‚äº†å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚
        </p>
        <div class="grid2">
          <div>
            <label>å›ç­”è€…æ°åï¼ˆå¿…é ˆï¼‰<input id="responderName" type="text" placeholder="ä¾‹ï¼‰å±±ç”°å¤ªéƒ"></label>
          </div>
        </div>
        <div class="foot"><button id="btnStart" disabled>æ¬¡ã¸ï¼ˆé–‹å§‹ï¼‰</button></div>
      </section>

      <section id="stepSurvey" class="hidden">
        <div class="sceneBox">
          <div class="sceneTitle">ã‚·ãƒ¼ãƒ³</div>
          <h2 id="sceneTitle"></h2>
          <p id="sceneText"></p>
          <!-- <span class="tag" id="methodTag"></span> -->
          <span class="tag" id="counterTag"></span>
        </div>
        <p class="muted">ç”»åƒã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚</p>
        <div class="imgWrap"><img id="targetImg" alt="è©•ä¾¡ç”»åƒ"></div>
        <div class="choices">
          <label><input type="checkbox" name="rating" value="æå†™ã§ãã¦ã„ã‚‹"> æå†™ã§ãã¦ã„ã‚‹</label>
          <label><input type="checkbox" name="rating" value="ã©ã¡ã‚‰ã§ã‚‚ãªã„"> ã©ã¡ã‚‰ã§ã‚‚ãªã„</label>
          <label><input type="checkbox" name="rating" value="æå†™ã§ãã¦ã„ãªã„"> æå†™ã§ãã¦ã„ãªã„</label>
        </div>
        <div class="controls">
          <button class="ghost" id="btnBack">æˆ»ã‚‹</button>
          <button id="btnNext">æ¬¡ã¸</button>
        </div>
        <p id="warnMsg" class="tiny muted"></p>
      </section>

      <section id="stepFinish" class="hidden center">
        <h1>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</h1>
        <p>å…¨ã¦ã®è©•ä¾¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
      </section>
    </div>
  </div>

<script>
// âœ… ã‚ãªãŸã®GASã®Webã‚¢ãƒ—ãƒªURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
const GAS_ENDPOINT = "https://urashima-survey.vercel.app/api/proxy";

// === é€²è¡Œä¿å­˜ç”¨ã‚­ãƒ¼ ===
const STORAGE_KEYS = {
  progress: "surveyProgress",          // { name, sceneIndex, imageIndex }
  sceneOrder: "surveySceneOrder",      // [ "S3","S5","S1","S2","S4" ] ãªã©
  imageOrders: "surveyImageOrders"     // { S1: [{method,url},...30], S2: [...], ... }
};

// ======== ã‚·ãƒ¼ãƒ³æ§‹æˆ ========
const scenes = [
  {
    id: "S1",
    title: "æµ¦å³¶å¤ªéƒãŒç‰æ‰‹ç®±ã‚’é–‹ã‘ã€ãŠçˆºã•ã‚“ã«ãªã‚‹ã‚·ãƒ¼ãƒ³",
    text: `æœ¬æ–‡ï¼š
ã€€ã—ãŠã—ãŠã¨ã¾ãŸæµœã¹ã¸å‡ºã¦ã¿ã¾ã—ãŸãŒã€æµ·ã®æ°´ã¯ã¾ã‚“ã¾ã‚“ã¨ãŸãŸãˆã¦ã„ã¦ã€ã©ã“ãŒã¯ã¦ã¨ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã€€ã‚‚ã†ã‹ã‚ã‚‚å‡ºã¦ãã¾ã›ã‚“ã‹ã‚‰ã€ã©ã†ã—ã¦ã‚Šã‚…ã†å®®ã¸ã‚ãŸã‚ã†æ‰‹ã ã¦ã‚‚ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ 
ã€€ãã®ã¨ãã€æµ¦å³¶ã¯ãµã¨ã€ã‹ã‹ãˆã¦ã„ãŸç‰æ‰‹ç®±ã«æ°—ãŒã¤ãã¾ã—ãŸã€‚

ã€Œãã†ã ã€‚ã“ã®ç®±ã¯ã“ã‚’ã‚ã‘ã¦ã¿ãŸã‚‰ã°ã€ã‚ã‹ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€

ã€€ã“ã†ãŠã‚‚ã†ã¨ã†ã‚Œã—ããªã£ã¦ã€æµ¦å³¶ã¯ã€ã†ã£ã‹ã‚Šä¹™å§«ã•ã¾ã«ã„ã‚ã‚ŒãŸã“ã¨ã¯ã‚ã™ã‚Œã¦ã€ç®±ã®ãµãŸã‚’ã¨ã‚Šã¾ã—ãŸã€‚ã™ã‚‹ã¨ã‚€ã‚‰ã•ãè‰²ã®é›²ãŒã€ãªã‹ã‹ã‚‰ã‚€ãã‚€ãç«‹ã¡ã®ã¼ã£ã¦ã€ãã‚ŒãŒé¡”ã«ã‹ã‹ã£ãŸã‹ã¨ãŠã‚‚ã†ã¨ã€ã™ã†ã£ã¨æ¶ˆãˆã¦è¡Œã£ã¦ç®±ã®ãªã‹ã«ã¯ãªã‚“ã«ã‚‚ã®ã“ã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ã€€ãã®ä»£ã‚ã‚Šã€ã„ã¤ã®ã¾ã«ã‹é¡”ã˜ã‚…ã†ã—ã‚ã«ãªã£ã¦ã€æ‰‹ã‚‚è¶³ã‚‚ã¡ã¢ã‹ã¾ã£ã¦ã€ãã‚Œã„ãªã¿ãã‚ã®æ°´ã«ã†ã¤ã£ãŸå½±ã‹ã’ã‚’è¦‹ã‚‹ã¨ã€é«ªã‹ã¿ã‚‚ã²ã’ã‚‚ã€ã¾ã£ã—ã‚ãªã€ã‹ã‚ã„ã„ãŠã˜ã„ã•ã‚“ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ã€€æµ¦å³¶ã¯ã‹ã‚‰ã«ãªã£ãŸç®±ã¯ã“ã®ãªã‹ã‚’ã®ãã„ã¦ã€

ã€Œãªã‚‹ã»ã©ã€ä¹™å§«ã•ã¾ãŒã€äººé–“ã®ã„ã¡ã°ã‚“ã ã„ã˜ãªãŸã‹ã‚‰ã‚’å…¥ã‚Œã¦ãŠãã¨ãŠã£ã—ã‚ƒã£ãŸã‚ã‚Œã¯ã€äººé–“ã®å¯¿å‘½ã ã£ãŸã®ã ãªã€

ã€€ã¨ã€ã–ã‚“ã­ã‚“ãã†ã«ã¤ã¶ã‚„ãã¾ã—ãŸã€‚
ã€€æ˜¥ã®æµ·ã¯ã©ã“ã¾ã§ã‚‚é ãã‹ã™ã‚“ã§ã„ã¾ã—ãŸã€‚ã©ã“ã‹ã‚‰ã‹ã„ã„å£°ã§èˆŸã†ãŸã‚’ã†ãŸã†ã®ãŒã€ã¾ãŸãã“ãˆã¦ãã¾ã—ãŸã€‚
ã€€æµ¦å³¶ã¯ã€ã¼ã‚“ã‚„ã‚Šã¨ã‚€ã‹ã—ã®ã“ã¨ã‚’ãŠã‚‚ã„å‡ºã—ã¦ã„ã¾ã—ãŸã€‚`,
    methods: [
      {name:"æ–¹æ³•Aï¼šåŸæ–‡ãã®ã¾ã¾",images:Array.from({length:10},(_,i)=>`img/scene1/a_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Bï¼šæŠ½å‡ºè¦ç´ ",images:Array.from({length:10},(_,i)=>`img/scene1/b_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Cï¼šè¦ç´„ãƒ™ãƒ¼ã‚¹",images:Array.from({length:10},(_,i)=>`img/scene1/c_${String(i+1).padStart(2,'0')}.png`)}
    ]
  },

  {
    id: "S2",
    title: "å†’é ­ã‚·ãƒ¼ãƒ³",
    text: `æœ¬æ–‡ï¼š
ã€€ã‚€ã‹ã—ã€ã‚€ã‹ã—ã€ä¸¹å¾Œã®å›½æ°´ã®æ±Ÿã®æµ¦ã«ã€æµ¦å³¶å¤ªéƒã¨ã„ã†æ¼å¸«ãŒã‚ã‚Šã¾ã—ãŸã€‚
ã€€æµ¦å³¶å¤ªéƒã¯ã€æ¯æ—¥é‡£ã‚Šç«¿ã‚’æ‹…ã„ã§ã¯æµ·ã¸å‡ºã‹ã‘ã¦ã€é¯›ã‚„ã€é°¹ãªã©ã®ãŠé­šã‚’é‡£ã£ã¦ã€ãŠçˆ¶ã•ã‚“ãŠæ¯ã•ã‚“ã‚’é¤Šã£ã¦ã„ã¾ã—ãŸã€‚`,
    methods: [
      {name:"æ–¹æ³•Aï¼šåŸæ–‡ãã®ã¾ã¾",images:Array.from({length:10},(_,i)=>`img/scene2/a_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Bï¼šæŠ½å‡ºè¦ç´ ",images:Array.from({length:10},(_,i)=>`img/scene2/b_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Cï¼šè¦ç´„ãƒ™ãƒ¼ã‚¹",images:Array.from({length:10},(_,i)=>`img/scene2/c_${String(i+1).padStart(2,'0')}.png`)}
    ]
  },

  {
    id: "S3",
    title: "äº€ãŒæµ¦å³¶å¤ªéƒã‚’ç«œå®®åŸã«èª˜ã†ã‚·ãƒ¼ãƒ³",
    text: `æœ¬æ–‡ï¼š
ã€€ãã‚Œã‹ã‚‰äºŒã€ä¸‰æ—¥ãŸã£ã¦ã€æµ¦å³¶ã¯ã¾ãŸèˆŸã«ã®ã£ã¦æµ·ã¸ã¤ã‚Šã«å‡ºã‹ã‘ã¾ã—ãŸã€‚
ã€€é ã„æ²–ã®ã»ã†ã¾ã§ã‚‚ã“ãå‡ºã—ã¦ã€ä¸€ç”Ÿã‘ã‚“ã‚ã„ãŠã•ã‹ãªã‚’ã¤ã£ã¦ã„ã¾ã™ã¨ã€ãµã¨ã†ã—ã‚ã®ã»ã†ã§

ã€Œæµ¦å³¶ã•ã‚“ã€æµ¦å³¶ã•ã‚“ã€

ã€€ã¨ã‚ˆã¶å£°ãŒã—ã¾ã—ãŸã€‚ãŠã‚„ã¨ãŠã‚‚ã£ã¦ãµã‚Šã‹ãˆã£ã¦ã¿ã¾ã™ã¨ã€ã ã‚Œã‚‚äººã®ã‹ã’ã¯è¦‹ãˆã¾ã›ã‚“ã€‚ãã®ä»£ã‚Šã€ã„ã¤ã®ã¾ã«ã‹ã€ä¸€ã´ãã®ã‹ã‚ãŒã€èˆŸã®ãã°ã«ãã¦ã„ã¾ã—ãŸã€‚

ã€€æµ¦å³¶ãŒãµã—ããã†ãªé¡”ã‚’ã—ã¦ã„ã‚‹ã¨ã€

ã€Œã‚ãŸãã—ã¯ã€å…ˆæ—¥åŠ©ã‘ã¦ã„ãŸã ã„ãŸã‹ã‚ã§ã”ã–ã„ã¾ã™ã€‚ãã‚‡ã†ã¯ã¡ã‚‡ã£ã¨ãã®ãŠç¤¼ã«ã¾ã„ã‚Šã¾ã—ãŸã€

ã€€ã‹ã‚ãŒã“ã†ã„ã£ãŸã®ã§ã€æµ¦å³¶ã¯ã³ã£ãã‚Šã—ã¾ã—ãŸã€‚

ã€Œã¾ã‚ã€ãã†ã‹ã„ã€‚ã‚ã–ã‚ã–ç¤¼ãªã‚“ãã„ã„ã«ãã‚‹ã«ã¯ãŠã‚ˆã°ãªã„ã®ã«ã€
ã€Œã§ã‚‚ã€ã»ã‚“ã¨ã†ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¨ãã«ã€æµ¦å³¶ã•ã‚“ã€ã‚ãªãŸã¯ã‚Šã‚…ã†å®®ã‚’ã”ã‚‰ã‚“ã«ãªã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ã€
ã€Œã„ã‚„ã€è©±ã«ã¯ãã„ã¦ã„ã‚‹ãŒã€ã¾ã è¦‹ãŸã“ã¨ã¯ãªã„ã‚ˆã€
ã€Œã§ã¯ã»ã‚“ã®ãŠç¤¼ã®ã—ã‚‹ã—ã«ã€ã‚ãŸãã—ãŒã‚Šã‚…ã†å®®ã‚’è¦‹ã›ã¦ä¸Šã’ãŸã„ã¨ãŠã‚‚ã„ã¾ã™ãŒã„ã‹ãŒã§ã—ã‚‡ã†ã€
ã€Œã¸ãˆã€ãã‚Œã¯ãŠã‚‚ã—ã‚ã„ã­ã€‚ãœã²è¡Œã£ã¦ã¿ãŸã„ãŒã€ãã‚Œã¯ãªã‚“ã§ã‚‚æµ·ã®åº•ã«ã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã¯ãªã„ã‹ã€‚ã©ã†ã—ã¦è¡Œãã¤ã‚‚ã‚Šã ã­ã€‚ã‚ãŸã—ã«ã¯ã¨ã¦ã‚‚ãã“ã¾ã§ãŠã‚ˆã„ã§ã¯è¡Œã‘ãªã„ã‚ˆã€
ã€Œãªã«ã€ã‚ã‘ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚ãŸãã—ã®èƒŒä¸­ã«ãŠã®ã‚Šãã ã•ã„ã€

ã€€ã‹ã‚ã¯ã“ã†ã„ã£ã¦ã€èƒŒä¸­ã‚’å‡ºã—ã¾ã—ãŸã€‚æµ¦å³¶ã¯åŠåˆ†ãã¿ã‚ã‚‹ããŠã‚‚ã„ãªãŒã‚‰ã€ã„ã‚ã‚Œã‚‹ã¾ã¾ã«ã€ã‹ã‚ã®èƒŒä¸­ã«ã®ã‚Šã¾ã—ãŸã€‚`,
    methods: [
      {name:"æ–¹æ³•Aï¼šåŸæ–‡ãã®ã¾ã¾",images:Array.from({length:10},(_,i)=>`img/scene3/a_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Bï¼šæŠ½å‡ºè¦ç´ ",images:Array.from({length:10},(_,i)=>`img/scene3/b_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Cï¼šè¦ç´„ãƒ™ãƒ¼ã‚¹",images:Array.from({length:10},(_,i)=>`img/scene3/c_${String(i+1).padStart(2,'0')}.png`)}
    ]
  },

  {
    id: "S4",
    title: "æµ¦å³¶å¤ªéƒãŒäº€ã®èƒŒã«ä¹—ã£ã¦ã€ç«œå®®åŸã‹ã‚‰æµœè¾ºã¸å¸°ã£ã¦ãã‚‹ã‚·ãƒ¼ãƒ³",
    text: `æœ¬æ–‡ï¼š
ã€€æµ¦å³¶ã¯ã†ã‚Œã—ã„ã®ã¨ã‹ãªã—ã„ã®ã¨ã§ã€èƒ¸ã‚€ã­ãŒã„ã£ã±ã„ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚ãã—ã¦ã‹ã‚ã®èƒŒä¸­ã«ã®ã‚Šã¾ã™ã¨ã€ã‹ã‚ã¯ã™ãæ³¢ã‚’åˆ‡ã£ã¦ä¸ŠãŒã£ã¦è¡Œã£ã¦ã€ã¾ã‚‚ãªãã‚‚ã¨ã®æµœã¹ã«ã¤ãã¾ã—ãŸã€‚

ã€Œã§ã¯æµ¦å³¶ã•ã‚“ã€ã”ãã’ã‚“ã‚ˆã‚ã—ã‚…ã†ã€

ã€€ã¨ã€ã‹ã‚ã¯ã„ã£ã¦ã€ã¾ãŸæ°´ã®ãªã‹ã«ã‚‚ãã£ã¦è¡Œãã¾ã—ãŸã€‚æµ¦å³¶ã¯ã—ã°ã‚‰ãã€ã‹ã‚ã®è¡Œã‚†ããˆã‚’è¦‹é€ã£ã¦ã„ã¾ã—ãŸã€‚
ã€€æµ¦å³¶ã¯æµ·ã°ãŸã«ç«‹ã£ãŸã¾ã¾ã€ã—ã°ã‚‰ããã“ã‚‰ã‚’è¦‹ã¾ã‚ã—ã¾ã—ãŸã€‚

ã€€æ˜¥ã®æ—¥ãŒã½ã‹ã½ã‹ã‚ãŸã£ã¦ã€ã„ã¡ã‚ã‚“ã«ã‹ã™ã‚“ã æµ·ã®ä¸Šã«ã€ã©ã“ã‹ã‚‰ã¨ã‚‚ãªãã€ã«ãã‚„ã‹ãªèˆŸã†ãŸãŒãã“ãˆã¾ã—ãŸã€‚
ã€€ãã‚Œã¯å¤¢ã®ãªã‹ã§è¦‹ãŸãµã‚‹ã•ã¨ã®æµœã¹ã®æ™¯è‰²ã¨ã¡ã£ã¨ã‚‚ã¡ãŒã£ãŸã¨ã“ã‚ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã€€ã‘ã‚Œã©ã‚ˆãè¦‹ã‚‹ã¨ã€ãã“ã‚‰ã®æ§˜å­ãŒãªã‚“ã¨ãªãã‹ã‚ã£ã¦ã„ã¦ã€ã‚ã†äººã‚‚ã‚ã†äººã‚‚ã€ã„ã£ã“ã†ã«è¦‹çŸ¥ã‚‰ãªã„é¡”ã°ã‹ã‚Šã§ã€ã‚€ã“ã†ã§ã‚‚ã¿ã‚‡ã†ãªé¡”ã‚’ã—ã¦ã€ã˜ã‚ã˜ã‚è¦‹ãªãŒã‚‰ã€ã“ã¨ã°ã‚‚ã‹ã‘ãšã«ã™ã¾ã—ã¦è¡Œã£ã¦ã—ã¾ã„ã¾ã™ã€‚`,
    methods: [
      {name:"æ–¹æ³•Aï¼šåŸæ–‡ãã®ã¾ã¾",images:Array.from({length:10},(_,i)=>`img/scene4/a_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Bï¼šæŠ½å‡ºè¦ç´ ",images:Array.from({length:10},(_,i)=>`img/scene4/b_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Cï¼šè¦ç´„ãƒ™ãƒ¼ã‚¹",images:Array.from({length:10},(_,i)=>`img/scene4/c_${String(i+1).padStart(2,'0')}.png`)}
    ]
  },

  {
    id: "S5",
    title: "å­ã©ã‚‚ãŸã¡ã«ã„ã˜ã‚ã‚‰ã‚Œã¦ã„ã‚‹äº€ã‚’æµ¦å³¶å¤ªéƒãŒè¦‹ã¤ã‘ã‚‹ã‚·ãƒ¼ãƒ³",
    text: `æœ¬æ–‡ï¼š
ã€€ã‚ã‚‹æ—¥ã€æµ¦å³¶ã¯ã„ã¤ã‚‚ã®é€šã‚Šæµ·ã¸å‡ºã¦ã€ä¸€æ—¥ãŠé­šã‚’é‡£ã£ã¦ã€å¸°ã£ã¦ãã¾ã—ãŸã€‚é€”ä¸­ã€å­ã©ã‚‚ãŒäº”ã€å…­äººå¾€æ¥ã«é›†ã¾ã£ã¦ã€ãŒã‚„ãŒã‚„è¨€ã£ã¦ã„ã¾ã—ãŸã€‚
ã€€ä½•ã‹ã¨ãŠã‚‚ã£ã¦æµ¦å³¶ãŒã®ãã„ã¦ã¿ã‚‹ã¨ã€å°ã•ã„ã‹ã‚ã®å­ã‚’ä¸€ã´ãã¤ã‹ã¾ãˆã¦ã€æ£’ã§ã¤ã¤ã„ãŸã‚Šã€çŸ³ã§ãŸãŸã„ãŸã‚Šã€ã•ã‚“ã–ã‚“ã«ã„ã˜ã‚ã¦ã„ã‚‹ã®ã§ã™ã€‚æµ¦å³¶ã¯è¦‹ã‹ã­ã¦ã€

ã€Œã¾ã‚ã€ãã‚“ãªã‹ã‚ã„ãã†ãªã“ã¨ã‚’ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„ã€‚ã„ã„å­ã ã‹ã‚‰ã€

ã€€ã¨ã€ã¨ã‚ã¾ã—ãŸãŒã€å­ã©ã‚‚ãŸã¡ã¯ããå…¥ã‚Œã‚ˆã†ã¨ã‚‚ã—ãªã„ã§ã€

ã€Œãªã‚“ã ã„ã€‚ãªã‚“ã ã„ã€ã‹ã¾ã†ã‚‚ã‚“ã‹ã„ã€

ã€€ã¨ã„ã„ãªãŒã‚‰ã€ã¾ãŸã‹ã‚ã®å­ã‚’ã€ã‚ãŠã‚€ã‘ã«ã²ã£ãã‚Šã‹ãˆã—ã¦ã€è¶³ã§ã‘ã£ãŸã‚Šã€ç ‚ã®ãªã‹ã«ã†ãšã‚ãŸã‚Šã—ã¾ã—ãŸã€‚
ã€€æµ¦å³¶ã¯ã¾ã™ã¾ã™ã‹ã‚ã„ãã†ã«ãŠã‚‚ã£ã¦ã€

ã€Œã˜ã‚ƒã‚ã€ãŠã˜ã•ã‚“ãŒãŠã‚ã—ã‚’ã‚ã’ã‚‹ã‹ã‚‰ã€ãã®ã‹ã‚ã®å­ã‚’å£²ã£ã¦ãŠãã‚Œã€

ã€€ã¨ã„ã„ã¾ã™ã¨ã€ã“ã©ã‚‚ãŸã¡ã¯ã€

ã€Œã†ã‚“ã†ã‚“ã€ãŠã‚ã—ã‚’ãã‚Œã‚‹ãªã‚‰ã‚„ã£ã¦ã‚‚ã„ã„ã€

ã€€ã¨ã„ã£ã¦ã€æ‰‹ã‚’å‡ºã—ã¾ã—ãŸã€‚ãã“ã§æµ¦å³¶ã¯ãŠã‚ã—ã‚’ã‚„ã£ã¦ã‹ã‚ã®å­ã‚’ã‚‚ã‚‰ã„ã†ã‘ã¾ã—ãŸã€‚
ã€€å­ã©ã‚‚ãŸã¡ã¯ã€

ã€ŒãŠã˜ã•ã‚“ã€ã‚ã‚ŠãŒã¨ã†ã€‚ã¾ãŸè²·ã£ã¦ãŠãã‚Œã‚ˆã€

ã€€ã¨ã€ã‚ã„ã‚ã„ã„ã„ãªãŒã‚‰ã€è¡Œã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚`,
    methods: [
      {name:"æ–¹æ³•Aï¼šåŸæ–‡ãã®ã¾ã¾",images:Array.from({length:10},(_,i)=>`img/scene5/a_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Bï¼šæŠ½å‡ºè¦ç´ ",images:Array.from({length:10},(_,i)=>`img/scene5/b_${String(i+1).padStart(2,'0')}.png`)},
      {name:"æ–¹æ³•Cï¼šè¦ç´„ãƒ™ãƒ¼ã‚¹",images:Array.from({length:10},(_,i)=>`img/scene5/c_${String(i+1).padStart(2,'0')}.png`)}
    ]
  }
];

// ======== ã‚·ãƒ¼ãƒ³é †ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã¨ä¿å­˜ãƒ»å¾©å…ƒ ========
function saveSceneOrder() {
  const ids = sceneOrder.map(s => s.id);
  localStorage.setItem(STORAGE_KEYS.sceneOrder, JSON.stringify(ids));
}

function loadSceneOrder() {
  const raw = localStorage.getItem(STORAGE_KEYS.sceneOrder);
  if (!raw) return null;
  try {
    const ids = JSON.parse(raw);
    return ids.map(id => scenes.find(s => s.id === id)).filter(Boolean);
  } catch {
    return null;
  }
}

// ======== å„ã‚·ãƒ¼ãƒ³å†…ã®ç”»åƒé †ã¨é€²è¡ŒçŠ¶æ³ã®ä¿å­˜ãƒ»å¾©å…ƒ ========
let sceneOrder = scenes.slice().sort(()=>Math.random()-0.5);

// --- ç”»åƒé †ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®å¤‰æ•° ---
let imageOrders = {}; // { S1: [{method,url}, ...30], S2: [...], ... }

// --- imageOrders ã‚’ä¿å­˜ ---
function saveImageOrders() {
  localStorage.setItem(STORAGE_KEYS.imageOrders, JSON.stringify(imageOrders));
}

// --- imageOrders ã‚’å¾©å…ƒ ---
function loadImageOrdersIfAny() {
  const raw = localStorage.getItem(STORAGE_KEYS.imageOrders);
  if (!raw) return false;
  try {
    imageOrders = JSON.parse(raw) || {};
    return true;
  } catch {
    imageOrders = {};
    return false;
  }
}

// --- é€²è¡ŒçŠ¶æ³ï¼ˆåå‰ãƒ»ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ãƒ»ç”»åƒç•ªå·ï¼‰ã‚’ä¿å­˜ ---
function saveProgress() {
  const progress = {
    name: nameInput.value.trim(),
    sceneIndex,
    imageIndex
  };
  localStorage.setItem(STORAGE_KEYS.progress, JSON.stringify(progress));
}

// --- ä¿å­˜ã•ã‚Œã¦ã„ãŸé€²è¡ŒçŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ ---
function loadProgressIfAny() {
  const raw = localStorage.getItem(STORAGE_KEYS.progress);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

// --- ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ï¼ˆå®Œäº†æ™‚ã«ä½¿ã†ï¼‰ ---
function clearAllSaved() {
  localStorage.removeItem(STORAGE_KEYS.progress);
  localStorage.removeItem(STORAGE_KEYS.sceneOrder);
  localStorage.removeItem(STORAGE_KEYS.imageOrders);
}

// ======== å…¥åŠ›ç¢ºèª ========
const btnStart=document.getElementById("btnStart");
const nameInput=document.getElementById("responderName");
function updateStartButton(){
  btnStart.disabled = !(nameInput.value.trim() );
}
nameInput.addEventListener("input",updateStartButton);

// ======== è¦ç´ å–å¾— ========
const stepIntro=document.getElementById("stepIntro");
const stepSurvey=document.getElementById("stepSurvey");
const stepFinish=document.getElementById("stepFinish");
const targetImg=document.getElementById("targetImg");
const sceneText=document.getElementById("sceneText");
// const methodTag=document.getElementById("methodTag");
const counterTag=document.getElementById("counterTag");
const ratingBoxes=document.querySelectorAll("input[name='rating']");
const warnMsg=document.getElementById("warnMsg");

let sceneIndex=0,imageIndex=0,currentImages=[];

// ======== ã‚·ãƒ¼ãƒ³ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼ˆä¿å­˜ã•ã‚ŒãŸé †ç•ªã‚’å†ç¾å¯¾å¿œï¼‰ ========
function randomizeScene(){
  const s = sceneOrder[sceneIndex];

  // ğŸ”¹ ã™ã§ã«ä¿å­˜æ¸ˆã¿ï¼ˆimageOrdersï¼‰ã«ä¸¦ã³é †ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ã†
  if (imageOrders[s.id] && Array.isArray(imageOrders[s.id]) && imageOrders[s.id].length === 30) {
    currentImages = imageOrders[s.id];
    return;
  }

  // ğŸ”¹ ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆï¼šæ–°ã—ãä½œã£ã¦ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã¦ä¿å­˜
  const imgs = [];
  s.methods.forEach(m => m.images.forEach(u => imgs.push({ method: m.name, url: u })));

  currentImages = imgs.sort(()=>Math.random()-0.5);
  imageOrders[s.id] = currentImages;  // ä¿å­˜ç”¨
  saveImageOrders();                  // ä¿å­˜
}

// ======== ç”»é¢è¡¨ç¤ºæ›´æ–° ========
function render(){
  const s=sceneOrder[sceneIndex];
  const img=currentImages[imageIndex];
  document.getElementById("sceneTitle").textContent = s.title;
  sceneText.innerHTML = s.text
    .split(/\n+/) // æ”¹è¡Œï¼ˆ1å€‹ä»¥ä¸Šï¼‰ã§æ®µè½ã«åˆ†å‰²
    .map(line => `<p style="text-indent: 1em; margin: 0.6em 0;">${line.trim()}</p>`)
    .join('');
  counterTag.textContent=`${imageIndex+1}/30`;
  targetImg.src=img.url;
  ratingBoxes.forEach(b=>b.checked=false);
  warnMsg.textContent="";
}

// ======== å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’GASã«é€ä¿¡ ========
async function saveResponse(name, scene, method, image, rating) {
  const payload = { name, scene, method, image, rating };
  try {
    await fetch(GAS_ENDPOINT, {
      method: "POST",
      mode: "cors",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });
  } catch (err) {
    console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
  }
}

// ======== é–‹å§‹ãƒœã‚¿ãƒ³ ========
btnStart.addEventListener("click", ()=>{
  // ğŸ”¹ ã‚¤ãƒ³ãƒˆãƒ­ç”»é¢ã‚’éš ã—ã¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
  stepIntro.classList.add("hidden");
  stepSurvey.classList.remove("hidden");

  // ğŸ”¹ ã‚·ãƒ¼ãƒ³é †ã‚’ä¿å­˜ï¼ˆsceneOrderã‚’å›ºå®šï¼‰
  saveSceneOrder();

  // ğŸ”¹ æœ€åˆã®ã‚·ãƒ¼ãƒ³ã®ç”»åƒé †ã‚’ä½œæˆãƒ»ä¿å­˜
  randomizeScene();

  // ğŸ”¹ æœ€åˆã®ç”»é¢ã‚’æç”»
  render();

  // ğŸ”¹ åˆæœŸé€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜
  saveProgress();
});

// ======== æ¬¡ã¸ãƒœã‚¿ãƒ³ ========
document.getElementById("btnNext").addEventListener("click", async ()=>{
  const chosen=[...ratingBoxes].find(b=>b.checked);
  if(!chosen){warnMsg.textContent="é¸æŠã—ã¦ãã ã•ã„";return;}

  const current = currentImages[imageIndex];
  const s = sceneOrder[sceneIndex];
  const name = nameInput.value.trim();

  // âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡
  await saveResponse(name, s.id, current.method, current.url, chosen.value);

  // ğŸŸ§ ã“ã“ã§é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜
  saveProgress();

  imageIndex++;
  if (imageIndex < 30) {
    render();
    saveProgress();
    return;
  }

  sceneIndex++;

  // âœ… ã¾ã æ¬¡ã®ã‚·ãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯æ¬¡ã®ã‚·ãƒ¼ãƒ³ã¸é€²ã‚€
  if (sceneIndex < sceneOrder.length) {
    imageIndex = 0;
    randomizeScene();
    render();
    saveProgress();
    return;
  }
  
  // âœ… å…¨ã¦ã®ã‚·ãƒ¼ãƒ³ã‚’è©•ä¾¡ã—çµ‚ã‚ã£ãŸã‚‰å®Œäº†ç”»é¢ã¸
  stepSurvey.classList.add("hidden");
  stepFinish.classList.remove("hidden");

  // ğŸŸ§ å®Œäº†æ™‚ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
  clearAllSaved();
});

// ======== æˆ»ã‚‹ãƒœã‚¿ãƒ³ ========
document.getElementById("btnBack").addEventListener("click",()=>{
  if(imageIndex>0){imageIndex--;render();}
  saveProgress(); // ğŸŸ¦ ã“ã“ã‚’è¿½åŠ ï¼æˆ»ã£ãŸä½ç½®ã‚‚ä¿å­˜
});

// ======== ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿æ™‚ã«é€²è¡Œã‚’å¾©å…ƒ ========
window.addEventListener("load", ()=>{
  const savedProgress = loadProgress();

  // âœ… ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¤ãƒ³ãƒˆãƒ­ç”»é¢ã¸
  if(!savedProgress || savedProgress.sceneIndex === undefined){
    return;
  }

  // âœ… ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é€²è¡ŒçŠ¶æ³ã‚’åæ˜ 
  sceneIndex = savedProgress.sceneIndex;
  imageIndex = savedProgress.imageIndex;
  const savedOrder = loadSceneOrder();

  if(savedOrder){
    sceneOrder.splice(0, sceneOrder.length, ...savedOrder);
  } else {
    // ã‚‚ã—é †ç•ªãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°æ–°ãŸã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    sceneOrder.sort(()=>Math.random()-0.5);
  }

  // âœ… ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ç”»åƒãƒªã‚¹ãƒˆã‚’å¾©å…ƒ
  randomizeScene();
  render();

  // âœ… ç”»é¢ã‚’ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
  stepIntro.classList.add("hidden");
  stepSurvey.classList.remove("hidden");
});
</script>
</body>
</html>
